<!DOCTYPE html>

<head>  
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Odyssey ExoMars</title>

  <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.7.3/leaflet.css" />
  <link rel="stylesheet" href="http://cartodb.github.io/odyssey.js/sandbox/css/slides.css"> 
  <link rel="stylesheet" href="http://libs.cartocdn.com/cartodb.js/v3/3.11/themes/css/cartodb.css" />
  
 
</head>
<body>
<!-- define element with id = map -->
		<div id = "map" style="width: 100%; height: 100%;"></div> 
		
		 <!-- define element with id = slides -->
		<div id = "slides_container" style="display:block;">
		
			<div id= "dots"></div> 
			<div id = "slides">
			<!-- SLIDE #0 -->
				<div class="slide">
					<h1 id="general0">Mars Landing Sites</h1>
					<p>Great explanation inside this chapter</br>with some incredible images and data</p>
					
				</div>
				<!-- SLIDE #1 -->
			<div class="slide">
					<h1 id="general1">Mars Landing Sites</h1>
					<p>Great explanation of the constraints</br>with some incredible images and data</p>
					
				</div>
				<!-- SLIDE #2 -->
			<div class="slide">
					<h1 id="general2">Mars Landing Sites</h1>
					<p>Great explanation of the constraints</br>with some incredible images and data</p>
					
				</div>
			
				<!-- SLIDE #3 -->
			<div class="slide">
					<h1 id="Aram">Aram Dorsum</h1>
					<p>Great explanation inside this chapter</br>with some incredible images and data</p>
					
				</div>
				<!-- SLIDE #4 -->
			<div class="slide">
					<h1 id="Hypanis">Hypanis Vallis</h1>
					<p>Great explanation inside this chapter</br>with some incredible images and data</p>
					
				</div>
				<!-- SLIDE #5 -->
				<div class="slide">
					<h1 id="Oxia">Oxia Planum</h1>
					<p>Great explanation inside this chapter</br>with some incredible images and data</p>
					
				</div>
				<!-- SLIDE #6 -->
				<div class="slide">
					<h1 id="Mawrth">Mawrth Vallis</h1>
					<p>Great explanation inside this chapter</br>with some incredible images and data</p>
					
				</div>	
				<!-- SLIDE #7 -->
				<div class="slide">
					<h1 id="end">The End</h1>
					<p>Great explanation inside this chapter</br>with some incredible images and data</p>
					
				</div>			
			</div>
			
		<ul id="navButtons" style="position:relative;">
			<li><a class = "prev"></a></li>
			<li><a class = "next"></a></li>		
	    </ul>	
	</div>
	
	
	
	<!-- call javascript libraries -->
	
	<script src="http://code.jquery.com/jquery-1.11.0.min.js"></script>
	<script src="http://libs.cartocdn.com/cartodb.js/v3/3.11/cartodb.js"></script>
    <script src="http://cartodb.github.io/odyssey.js/dist/odyssey.js" charset="UTF-8"></script>			
			
	<script>
	
	
	var app =  {};


	
	// 2. define odyssey as a property of the ExoMars object. The value of the property is a function.
	
	app.odysseyTest = (function(w,d,$,O){


	// define object that have all the elements and layers 
		var el = {
			map: null,
			basemap: null, // MOLA grey_scale
			story: null,
			tileLayerAramHiRISE: null, 
			tileLayerAramHrsc: null,
			tileLayerHypanisHiRISE: null, 
			tileLayerHypanisHrsc: null,
			tileLayerMawrthHrsc: null,
			// landing sites
			Aram: null,
			Hypanis:null,
			Oxia: null,
			Mawrth: null,
			// center of the landingSite
			center: null,
			// CartoDB layers
			landingSite: null,
			latConstraint: null,
			ellipses: null,
			};
	
	
	// 	define function that initiates the map element
		
		var initMap = function(){
			
			// define map
			el.map =  new L.Map('map', { 
      		center: [15,-10],
      		zoom: 4,
      		zoomControl: true,
      		minZoom: 4,
            maxZoom:10
    		});
    		
    		// define basemap
    		el.basemap = new L.tileLayer('http://gislab.esac.esa.int/data/whereonmars/tiles/mola-gray/{z}/{x}/{y}.png', {
 			attribution: 'GISLAB',
  			minZoom: 0,
  			maxZoom: 5,
  			
  			unloadInvisibleTiles: true, // If true, all the tiles that are not visible after panning are removed 
  			updateWhenIdle: false // If true, all the tiles that are not visible after panning are removed 
			}).addTo(el.map).setZIndex(0);
			
			
			/*  The overlays are in zIndex = 1 ( they are above the basemap layers)*/
			// define overlays Hrsc
			
			el.tileLayerAramHrsc = new L.tileLayer('http://gislab.esac.esa.int/data/whereonmars/tiles/hrsc_mosaic_aram-dorsum/{z}/{x}/{y}.png',{
  			tms:true,
  			minZoom: 5,
  			maxZoom: 10,
  			
  			unloadInvisibleTiles: true, // If true, all the tiles that are not visible after panning are removed 
  			updateWhenIdle: false, // If false, new tiles are loaded during panning, otherwise only after it (when true)
   			bounds: L.latLngBounds(
 				L.latLng(5.87, -13.8), // southwest part of the BBox
 				L.latLng(9.87, -9.2)) // northeast part of the BBox
			}).addTo(el.map).setZIndex(1); 
			
			el.tileLayerHypanisHrsc = new L.tileLayer('http://gislab.esac.esa.int/data/whereonmars/tiles/hrsc_mosaic_hypanis/{z}/{x}/{y}.png',{
 			tms:true,
  			minZoom: 5,
  			maxZoom: 10,
  			
  			unloadInvisibleTiles: true, // If true, all the tiles that are not visible after panning are removed 
  			updateWhenIdle: false, // If false, new tiles are loaded during panning, otherwise only after it (when true)
   			bounds: L.latLngBounds(
 				L.latLng(9.8, -47.04),// southwest part of the BBox
 				L.latLng(13.8, -43.04)) // northeast part of the BBox
			}).addTo(el.map).setZIndex(1);
			
			el.tileLayerMawrthHrsc = new L.tileLayer('http://gislab.esac.esa.int/data/whereonmars/tiles/hrsc_mosaic_mawrth-vallis/{z}/{x}/{y}.png',{
 			tms:true,
  			minZoom: 5,
  			maxZoom: 10,
  			reuseTiles: false,
  			unloadInvisibleTiles: true, // If true, all the tiles that are not visible after panning are removed 
  			updateWhenIdle: true, // If false, new tiles are loaded during panning, otherwise only after it (when true)
   			bounds: L.latLngBounds(
 				L.latLng(20.16, -19.95),// southwest part of the BBox
 				L.latLng(24.16, -15.95)) // northeast part of the BBox
			}).addTo(el.map).setZIndex(1);
			///////////////////////////////////////////
			// define overlays HiRISE
			el.tileLayerAramHiRISE = new L.tileLayer('http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
  			minZoom: 8,
  			maxZoom: 10,
  			
  			unloadInvisibleTiles: true, // If true, all the tiles that are not visible after panning are removed 
  			//updateWhenIdle: false, // If false, new tiles are loaded during panning, otherwise only after it (when true)
   			bounds: L.latLngBounds(
 				L.latLng(5.87, -13.8), // southwest part of the BBox
 				L.latLng(9.87, -9.2)) // northeast part of the BBox
			}).addTo(el.map).setZIndex(2); 
			
		
			el.tileLayerHypanisHiRISE = new L.tileLayer('http://gislab.esac.esa.int/data/whereonmars/tiles/h0894_0000_nd4/{z}/{x}/{y}.png',{
 			tms:true,
  			minZoom: 8,
  			maxZoom: 10,
  			
  			unloadInvisibleTiles: true, // If true, all the tiles that are not visible after panning are removed 
  			//updateWhenIdle: false, // If false, new tiles are loaded during panning, otherwise only after it (when true)
   			bounds: L.latLngBounds(
 				L.latLng(9.8, -47.04),// southwest part of the BBox
 				L.latLng(13.8, -43.04)) // northeast part of the BBox
			}).addTo(el.map).setZIndex(2);
		
		
			el.Aram = new L.LatLng(7.87, -11.2);
			el.Hypanis = new L.LatLng(11.8, -45.04);
			el.Oxia = new L.LatLng(18.2, -24.55);
			el.Mawrth = new L.LatLng(22.16, -17.95);
			el.center = new L.LatLng(15,-10);
	    }
		
	// define a function that loads cartoDB data into the map
	
		var cartodbData = function(){
			
			var layerURL = 'http://whereonmars.cartodb.com/api/v2/viz/03ec7c7c-bc6a-11e4-b600-0e4fddd5de28/viz.json';
			// create cartoDB layer from vizjson url
			 
			var LS = cartodb.createLayer(el.map, layerURL)
				.on('done', function(layer) {
		  		
		  		 layer.setZIndex(100); // all cartoDB layer will be above all the baselayers
		  		 var sublayer =layer.getSubLayer(0);
		  		 
		  	   	el.landingSite = layer.createSubLayer({
		  	   	sql: "SELECT * FROM exomars_landing_sites_four",
		  		cartocss: '#exomars_landing_sites_four{marker-fill-opacity: 0.9;marker-line-color: #FFF; marker-line-width: 1.5;  marker-line-opacity: 1;marker-placement: point;marker-type: ellipse;  marker-width: 10;marker-fill: #FF6600;  marker-allow-overlap: true;}'

 	   	
		  	   	});
		  	   	el.latConstraint = layer.createSubLayer({
		  			sql: "SELECT * FROM lat_constraints",
		  			cartocss: '#lat_constraints{polygon-fill: #000000;polygon-opacity: 0.4;line-color: #f40202;line-width: 1;line-opacity: 1;}'

		  		
		  		    });
		  		  el.ellipses = layer.createSubLayer({
		  			sql: "SELECT * FROM exomars_landing_sites_ellipses",
		  			cartocss: '#exomars_landing_sites_ellipses{polygon-fill: #FF6600;polygon-opacity: 0.7;line-color: #FFF; line-width: 1;line-opacity: 1;}'
		  	
 
		
		  		    });
		  		
		  		
		  		// hide layers when load the map element
		  		el.landingSite.show();
		  		el.latConstraint.hide();
		  		el.ellipses.hide();
		  		// add cartoDB layers into the map
		  		el.map.addLayer(layer, false);
		  		});
		}
		  		
	
 function click(el) {
      var element = O.Core.getElement(el);
      var t = O.Trigger();

      function click() {
        
        t.trigger();
      }

      if (element) element.onclick = click;

      return t;
    }
	 // trigger a custom event called SlideChange
    var emitSlideChange = O.Action( function() {
     $(document).trigger('slideChange', function(){
      trackCurrentSlide();
     });
    });  	
	
	// listen for the slideChange event to be triggered
    function listenSlideChange() {
      $(document).on('slideChange', function() {
        
        trackCurrentSlide();
      });
    }
    
    // fire "this" each time the user changes a slide
    
    function trackCurrentSlide(){
    slides = $('#slides').children(); // creates an array of slides
    slides.each(function(i){
    	if ($(this).hasClass('selected')){ // if the element contains selected as class
        console.log('index: ', i);
    		checkIndex(i);
    		}
    	});
    
    
    }
    
    
    // check the index being returned by trackCurrentSlide()
    function checkIndex(index) {
      switch(index){

        case 0: console.log('overview'), slideZero(); 
        break;
        case 1: console.log('latconstraint'), slideOne();
        break;
        case 2: console.log('ellipses'), slideTwo();
        break;
        case 3: console.log('aram dorsum'), slideThree();
        break;
        case 4: console.log('hypanis vallis');
        break;
        case 5: console.log('oxia planum');
        break;
        case 6: console.log('mawrth vallis');
        break;
        case 7: console.log('the end'), slideSeven();
        break;
            
            
        default: console.log('other');  
      }
    }
    
    function slideZero() {
      // only show landing sites
     el.landingSite.show();
	 el.latConstraint.hide();
	 el.ellipses.hide();
    }

    function slideOne() {      
    //add the latitude constraint
      el.latConstraint.show();  
      el.ellipses.hide(); 
      el.landingSite.show();
         
    }

    function slideTwo() {
     //add the ellipses
     el.landingSite.hide();  
     el.ellipses.show();   
    }

    function slideThree() {
     el.landingSite.show();  
     el.latConstraint.hide();
     el.ellipses.hide();
     
    }

   
    function slideSeven() {
     el.landingSite.show();  
     el.latConstraint.hide(); 
     el.ellipses.hide();
    }
    
     
    function initOdyssey(O) {

      // O is for Odyssey
      var map = el.map;

      var seq = O.Triggers.Sequential();

      // enable keys to move slides
      O.Triggers.Keys().left().then(seq.prev, seq)
      O.Triggers.Keys().right().then(seq.next, seq)
      // set up triggers for slide arrows 
      click(document.querySelectorAll('.next')).then(seq.next, seq)
      click(document.querySelectorAll('.prev')).then(seq.prev, seq)  

      var slides = O.Actions.Slides('slides');
      
      el.story =  O.Story()
        .addState(
          seq.step(0),
          O.Parallel(  
          
          //setting setView here I assure that when the user zoom to a center or the landing sites
          // coordinates, it will go to the coordinates
          //There's a "bug" in leaflet that if you put panTo() and setZoom()
          // it won't go to the coordinates requested
          
            el.map.actions.setView(el.center,4), 
			slides.activate(0),
            emitSlideChange
          )
        )
        .addState(
          seq.step(1),
          O.Parallel(
          // setting setView here I assure that if the user click prev button,
          // it will show the overview 
            el.map.actions.setView(el.center,4), 
            slides.activate(1),
            emitSlideChange
          )
        )
        // setview(coordinates to pan, zoom level, true: "reset the map view"(without animations of panning)) If true is not added, it will
        // load the overlays that should disappear when the user change the slide. For example: if the minZoom it's 7 and the user change to
        // a slide where the the minZoom is 5 it keeps the tile layer even if the layer minZoom is 7
        .addState(
          seq.step(2),
          O.Parallel(
           // setting setView here I assure that if the user clicl prev button,
          // it will show the overview and not the Aram Dorsum view ( step 3())
            el.map.actions.setView(el.center,4,true),            
            slides.activate(2),
            emitSlideChange
          )
        )
        .addState(
          seq.step(3),
          O.Parallel(                        
            el.map.actions.setView(el.Aram,7),
            slides.activate(3),
            emitSlideChange
          )
        )                  
        .addState(
          seq.step(4),
          O.Parallel(            
            el.map.actions.setView(el.Hypanis,7),
            slides.activate(4),
            emitSlideChange         
          )
        )
        .addState(
          seq.step(5),
          O.Parallel(            
            el.map.actions.setView(el.Oxia,7),
            slides.activate(5),
            emitSlideChange       
          )
        )
        .addState(
          seq.step(6),
          O.Parallel(         
            el.map.actions.setView(el.Mawrth,7),
            slides.activate(6),
            emitSlideChange       
          )
        )                
        .addState(
          seq.step(7),
          O.Parallel(
          	
            el.map.actions.setView(el.center,4,true),
            slides.activate(7),
            emitSlideChange)
          );
        
           
        
      el.story.go(0);
    }  	
		
	function init() {
      initMap();
      cartodbData();
      initOdyssey(O);
      listenSlideChange();            
    } 

    return {
      init : init,
      el: el
    }	
		
	
	})(window, document, jQuery,O);
	
	// 3. when the document has been completely loaded and parsed it applies the function to the window element  
	
	window.addEventListener("DOMContentLoaded", function(){
    app.odysseyTest.init();
  });
	
	</script>	

</body>
</html>		
		
		
		
		
		
		
	